<?xml version='1.0'?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
<!ENTITY % BOOK_ENTITIES SYSTEM "JAIN_SLEE_Example_User_Guide.ent">
%BOOK_ENTITIES;
]>

<section id="source_jbpm">
	<title>jBPM</title>

	<para>&THIS.EXAMPLE;
		Example
		<acronym>JBPM</acronym>
		related source is simple. Example defines two custom classes to
		perform additional tasks within flow.
		Also
		<acronym>XML</acronym>
		process definition consists of simple, not complex menu to ease
		learning process.

	</para>
	<section id="source_jbpm_decision">
		<title>Decision handler</title>
		<para>Decisions are performed by custom handler, its source looks as
			follows: </para>
		<programlisting language="Java" role="JAVA">
package org.mobicents.example.ss7.ussd.jbpm;

import java.util.Map;

import org.apache.log4j.Logger;
import org.jbpm.graph.exe.ExecutionContext;
import org.jbpm.graph.node.DecisionHandler;

public class USSDDecisionHandler implements DecisionHandler {

	private static final Logger logger = Logger.getLogger(USSDDecisionHandler.class);
	
	public static final String _INPUT_ = "ussd.input";
	public static final String _END_ = "end";
	public String decide(ExecutionContext ctx) throws Exception {
		//get what we got from user
		String input = (String) ctx.getVariable(_INPUT_);
		Map transitions = ctx.getNode().getLeavingTransitionsMap();

		if(transitions.get(input) == null)
		{
			return _END_;
		}else
		{
			return ""+input;
		}
				
		
	}

}
		</programlisting>
		<para>
			Handler expects user input to be passed as context variable with
			specific name. Its value is set by process user(here, by service,
			refer
			<xref linkend="source_service_sbb_source_ussd" />
			). In case there is no transition under passed input, handler falls
			back to predefined transition(not it MUST be present in
			<acronym>XML </acronym>
			definition).
		</para>
		<para>Decision handler is bound into process with following
			declaration:</para>
		<programlisting language="XML" role="XML"><![CDATA[
<decision name="welcome_decision" expr="#{ussd.input}">
		<handler class="org.mobicents.example.ss7.ussd.jbpm.USSDDecisionHandler" />
		
		<transition name="1" to="schedule" />
		<transition name="2" to="location" />
		<transition name="3" to="discount" />
		<transition name="4" to="promo" />
		<!-- this is default transition to end, it has to be present -->	
		<transition name="end" to="end" />	
		
	</decision>
			]]>
			</programlisting>
	</section>
	<section id="source_jbpm_prompt">
		<title>Prompt handler</title>
		<para>
			Prompt is set in process context by custom handler. Handler is
			activated once process enters state(it is defined in
			<acronym>XML</acronym>
			definition of process).
			Source looks as follows:
		</para>
		<programlisting language="Java" role="JAVA">
package org.mobicents.example.ss7.ussd.jbpm;

import org.jbpm.graph.def.ActionHandler;
import org.jbpm.graph.exe.ExecutionContext;

public class USSDPromptHandler implements ActionHandler {
	public static final String _PROMPT_ = "ussd.prompt";
	private String prompt;
	private boolean end = false;

	/**
	 * @return the end
	 */
	public boolean isEnd() {
		return end;
	}

	/**
	 * @param end
	 *            the end to set
	 */
	public void setEnd(boolean end) {
		this.end = end;
	}

	/**
	 * @return the prompt
	 */
	public String getPrompt() {
		return prompt;
	}

	/**
	 * @param prompt
	 *            the prompt to set
	 */
	public void setPrompt(String prompt) {
		this.prompt = prompt;
	}

	public void execute(ExecutionContext ctx) throws Exception {
		ctx.setVariable(_PROMPT_, prompt);
		if (end) {
			// make transition
			ctx.leaveNode();
		}
	}

}	
		</programlisting>
		<para>
			Note that this handler has additional property. This property
			controls whether process should move to another state, once proper
			prompt is set, or not. Process state which set this property to true
			<literal>MUST</literal>
			declare single transition, refer to
			<xref linkend="source_jbpm_xml" />
			for details
		</para>
		<para>
			Prompt handler is bound into process with following declaration:
		</para>
		<programlisting language="XML" role="XML"><![CDATA[
<state name="welcome">

		<event type='node-enter'>
       		<action class='org.mobicents.example.ss7.ussd.jbpm.USSDPromptHandler'>
       			<prompt>Welcome to train station scheduler service. Press following digits for 1) Train schedule.  2) Station location. 3) Discount rates. 4) Promo</prompt>
       		</action>
      	</event>
 
		<transition name="welcome" to="welcome_decision" />

</state>
			]]>
			</programlisting>
	</section>
	<section id="source_jbpm_xml">
		<title>XML Process definition</title>
		<para>
			Process is defined in single file,
			<filename>trainstation.jpdl.xml</filename>. Its content looks as follows:
		</para>
		<programlisting  language="XML" role="XML">
		<![CDATA[
<?xml version="1.0" encoding="UTF-8"?>

<process name="TrainStationDecisions"  xmlns="urn:jbpm.org:jpdl-3.2">

	<start-state>
		<transition to="welcome" />
	</start-state>

	<state name="welcome">
		]]><co id="example.jbpm.co1"/><![CDATA[
		<event type='node-enter'>
       		<action class='org.mobicents.example.ss7.ussd.jbpm.USSDPromptHandler'>
       			<prompt>Welcome to train station scheduler service. Press following digits for 1) Train schedule.  2) Station location. 3) Discount rates. 4) Promo</prompt>
       		</action>
      	</event>
            ]]><co id="example.jbpm.co2"/><![CDATA[
		<transition name="welcome" to="welcome_decision" />

	</state>

	]]><co id="example.jbpm.co3"/><![CDATA[
	<decision name="welcome_decision" expr="#{ussd.input}">
	]]><co id="example.jbpm.co4"/><![CDATA[
		<handler class="org.mobicents.example.ss7.ussd.jbpm.USSDDecisionHandler" />
		]]><co id="example.jbpm.co5"/><![CDATA[
		<transition name="1" to="schedule" />
		<transition name="2" to="location" />
		<transition name="3" to="discount" />
		<transition name="4" to="promo" />
		]]><co id="example.jbpm.co6"/><![CDATA[
		<!-- this is default transition to end, it has to be present -->	
		<transition name="end" to="end" />	
		
	</decision>
	<!-- SCHEDULE -->
	<state name="schedule">
	
		<event type='node-enter'>
       		<action class='org.mobicents.example.ss7.ussd.jbpm.USSDPromptHandler'>
       			<prompt>Please pick city 1) Pune.  2) Test location. 3) Volgograd. 4) End</prompt>
       		</action>
      	</event>
		<transition name="decide" to="schedule_decision" />
	</state>

	
	<decision name="schedule_decision" expr="#{ussd.input}">
		<handler class="org.mobicents.example.ss7.ussd.jbpm.USSDDecisionHandler" />
		
		<transition name="1" to="schedule_pune" />
		<transition name="2" to="schedule_test" />
		<transition name="3" to="schedule_volgograd" />
		<transition name="4" to="end" />
		<!-- this is default transition to end, it has to be present -->	
		<transition name="end" to="end" />	
	</decision>
	
	<state name="schedule_pune">
	
		<event type='node-enter'>
       		<action class='org.mobicents.example.ss7.ussd.jbpm.USSDPromptHandler'>
       			<prompt>Trains leave to each destination on each odd hour.</prompt>
       			<end>true</end>
       		</action>
      	</event>
		<transition name="end" to="end" />
	</state>>
	<state name="schedule_test">
	
		<event type='node-enter'>
       		<action class='org.mobicents.example.ss7.ussd.jbpm.USSDPromptHandler'>
       			<prompt>Test location does not have any means of transport!</prompt>
       			<end>true</end>
       		</action>
      	</event>
		<transition name="end" to="end" />
	</state>
	<state name="schedule_volgograd">
	
		<event type='node-enter'>
       		<action class='org.mobicents.example.ss7.ussd.jbpm.USSDPromptHandler'>
       			<prompt>Test location does not have any means of transport!</prompt>
       			<end>true</end>
       		</action>
      	</event>
		<transition name="end" to="end" />
	</state>
	
	<!-- LOCATION -->
	<state name="location">
	
		<event type='node-enter'>
       		<action class='org.mobicents.example.ss7.ussd.jbpm.USSDPromptHandler'>
       			<prompt>Please pick city 1) Pune.  2) Test location. 3) Volgograd. 4) End</prompt>
       		</action>
      	</event>
		<transition name="decide" to="location_decision" />
	</state>

	
	<decision name="location_decision" expr="#{ussd.input}">
		<handler class="org.mobicents.example.ss7.ussd.jbpm.USSDDecisionHandler" />
		
		<transition name="1" to="location_pune" />
		<transition name="2" to="location_test" />
		<transition name="3" to="location_volgograd" />
		<transition name="4" to="end" />	
		<!-- this is default transition to end, it has to be present -->	
		<transition name="end" to="end" />	
	</decision>
	
	<state name="location_pune">
	
		<event type='node-enter'>
       		<action class='org.mobicents.example.ss7.ussd.jbpm.USSDPromptHandler'>
       			<prompt>Train station is located at 353, Laxmi Road, Near Vijay Talkies .</prompt>
       			<end>true</end>
       		</action>
      	</event>
		<transition name="end" to="end" />
	</state>
	<state name="location_test">
	
		<event type='node-enter'>
       		<action class='org.mobicents.example.ss7.ussd.jbpm.USSDPromptHandler'>
       			<prompt>Test location does not have any means of transport!</prompt>
       			<end>true</end>
       		</action>
      	</event>
		<transition name="end" to="end" />
	</state>
	<state name="location_volgograd">
	
		<event type='node-enter'>
       		<action class='org.mobicents.example.ss7.ussd.jbpm.USSDPromptHandler'>
       			<prompt>Train stations are located at: xxx</prompt>
       			<end>true</end>
       		</action>
      	</event>
		<transition name="end" to="end" />
	</state>
	<!-- DISCOUNT -->
	<state name="discount">
	
		<event type='node-enter'>
       		<action class='org.mobicents.example.ss7.ussd.jbpm.USSDPromptHandler'>
       			<prompt>There are no DISCOUNT! Pay the price!</prompt>
       			<end>true</end>
       		</action>
      	</event>
		<transition name="end" to="end" />
	</state>
	<!-- PROMO -->
	<state name="promo">
	
		<event type='node-enter'>
       		<action class='org.mobicents.example.ss7.ussd.jbpm.USSDPromptHandler'>
       			<prompt>You are now trapped in endles loop! Press something!</prompt>
       			<end>true</end>
       		</action>
      	</event>
		<transition name="decide" to="discount_decision" />
	</state>
	<decision name="discount_decision" expr="#{ussd.input}">
		<handler class="org.mobicents.example.ss7.ussd.jbpm.USSDDecisionHandler" />
		
		<transition name="0" to="end" />
		<transition name="end" to="discount" />	
		
	</decision>
	
	
	<end-state name="end" />

</process>

			]]>
			</programlisting>
			<para><acronym>XML</acronym> definition has following, distinct elements: </para>
			<calloutlist>
				<callout arearefs="example.jbpm.co1">
					<para>declaration of prompt for current state.</para>
				</callout>
				<callout arearefs="example.jbpm.co2">
					<para>declaration of transition to decision element.</para>
				</callout>
				<callout arearefs="example.jbpm.co3">
					<para>declaration of decision element.</para>
				</callout>
				<callout arearefs="example.jbpm.co4">
					<para>declaration of decision handler.</para>
				</callout>
				<callout arearefs="example.jbpm.co5">
					<para>declaration of transitions from decision element.</para>
				</callout>
				<callout arearefs="example.jbpm.co6">
					<para>declaration of default transition.</para>
				</callout>
			
			</calloutlist>
	</section>


</section>	